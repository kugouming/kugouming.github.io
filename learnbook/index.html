
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>程序员自修</title>
    <link rel="shortcut icon" href="/assets/images/logobig.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="description" content="Description">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/assets/css/themes.vue.css">
</head>
<body oncontextmenu="return false" ondragstart="return false">
    <div id="app">Please waiting...</div>
    <script src="/assets/js/config.min.js"></script>
    <script>
        // OnLine 模式禁止控制台查看
        // const IS_RELEASE = true
        const IS_RELEASE = false

        // 离线模式
        if (typeof navigator.serviceWorker !== 'undefined') {
            navigator.serviceWorker.register('sw.js')
        }

        try{
            // 视频播放组件全局变量
            let videoPlayer = {
                mime: "",
                segments: [],
                mediaSource: new MediaSource(),
                transmuxer: new muxjs.mp4.Transmuxer(),
            }
        } catch (error) {
            // alert(error)
            console.error(error);
        }

        window.__COVERPAGEFLAG__ = false;
        window.$docsify = {
            onlyCover:false,
            loadSidebar: true,
            loadNavbar: '',
            subMaxLevel: 3,
            namespace: 'default',
            auto2top: true,
            name: '程序员自修',
            logo:'',
            coverpage: false,
            search: {
                paths: 'auto',
                placeholder: '检索',
                noData: 'No Results!'
            },
            scrollToTop: {
                auto: true,
                text: 'Top',
                right: 15,
                bottom: 15,
                offset: 500
            },
            plugins: [
                EditOnGithubPlugin.create(
                    'https://github.com/kugouming/kugouming.github.io/blob/master/',
                    'https://github.com/kugouming/kugouming.github.io/blob/master/learnbook/',
                    function(file) {
                        return '编辑'
                    }
                ),
                function (hook, vm) {
                    // 每个页面加载完成都需要执行此区域，为每页新增返回文档首页按钮
                    hook.doneEach(function() {
                        let container = document.querySelector('section.content');
                        let childFirst = document.getElementById('main');
                        let childInsert = document.createElement('div');
                        childInsert.style = "float: right;position: absolute;right: 0;top: 0;background: #f6f7fb;width: 100%;clear: both;padding: 6px 20px;text-align: right;text-underline-position: under;";
                        // bca-disable-next-line
                        childInsert.innerHTML = "<a href='../#/' style='text-decoration: none;color: #87878a;font-weight:600;'>返回首页</a>";
                        container.insertBefore(childInsert, childFirst);

                        // 畅言评论组件注册
                        let childAppend = document.createElement('div');
                        childAppend.id = 'SOHUCS'
                        childAppend.style='font-size: 16px;max-width: 80%;margin: 0 auto;'
                        container.appendChild(childAppend);
                        showpinglun();

                        // 视频播放（ts文件）
                        playvideo()
                    });
                },
            ]
        };

        // 禁止查看控制台
        function fuckyou() {
            window.close(); //关闭当前窗口(防抽)
            // window.location = "about:blank"; //将当前窗口跳转置空白页 （打开控制台后，还可以通过回退按钮回退）
            window.open("about:blank"); // 重新打开一个新窗口，这样用户通过回退也无法查看原网页
        }
        function blockConsole() {
            // 判断当前窗口内页高度和窗口高度，如果差值大于200，那么呵呵
            if ((window.outerHeight - window.innerHeight) > 200)
                fuckyou();
            // 判断当前窗口内页高度和窗口宽度，如果差值大于200
            if ((window.outerWidth - window.innerWidth) > 200)
                fuckyou();
        }

        window.onload = function() {
            if (IS_RELEASE) {
                blockConsole()
                window.onresize = function(){
                    blockConsole()
                }
            }
        }

        // 视频播放（ts文件）
        function playvideo() {
            if (document.querySelector('video') == null) {
                return
            }
            
            let vobj   = document.querySelector('video')
            let svalue = vobj.attributes['segments'].value
            videoPlayer.mime   = vobj.attributes['mime'].value
            let plist  = svalue.split(",")
            for (i = 0; i < plist.length; i++) {
                let v = plist[i].trim()
                if (v.length > 0) {
                    videoPlayer.segments.push(v)
                }
            }


            video = document.querySelector('video');
            video.src = URL.createObjectURL(videoPlayer.mediaSource);
            videoPlayer.mediaSource.addEventListener("sourceopen", appendFirstSegment);
        }

        function appendFirstSegment() {
            if (videoPlayer.segments.length == 0) {
                return;
            }

            URL.revokeObjectURL(video.src);
            sourceBuffer = videoPlayer.mediaSource.addSourceBuffer(videoPlayer.mime);
            sourceBuffer.addEventListener('updateend', appendNextSegment);

            videoPlayer.transmuxer.on('data', (segment) => {
                let data = new Uint8Array(segment.initSegment.byteLength + segment.data.byteLength);
                data.set(segment.initSegment, 0);
                data.set(segment.data, segment.initSegment.byteLength);
                console.log(muxjs.mp4.tools.inspect(data));
                sourceBuffer.appendBuffer(data);
            })

            fetch(videoPlayer.segments.shift()).then((response) => {
                return response.arrayBuffer();
            }).then((response) => {
                videoPlayer.transmuxer.push(new Uint8Array(response));
                videoPlayer.transmuxer.flush();
            })
        }

        function appendNextSegment() {
            // reset the 'data' event listener to just append (moof/mdat) boxes to the Source Buffer
            videoPlayer.transmuxer.off('data');
            videoPlayer.transmuxer.on('data', (segment) => {
                sourceBuffer.appendBuffer(new Uint8Array(segment.data));
            })

            if (videoPlayer.segments.length == 0) {
                // notify MSE that we have no more segments to append.
                videoPlayer.mediaSource.endOfStream();
            }

            videoPlayer.segments.forEach((segment) => {
                // fetch the next segment from the segments array and pass it into the transmuxer.push method
                fetch(videoPlayer.segments.shift()).then((response) => {
                    return response.arrayBuffer();
                }).then((response) => {
                    videoPlayer.transmuxer.push(new Uint8Array(response));
                    videoPlayer.transmuxer.flush();
                })
            })
        }

        // 展示畅言评论插件
        function showpinglun(){
            var appid = 'cyvJltPMs';
            var conf = 'prod_5a59f7fcd51ba4c3bfad8a9a465671dd';
            var width = window.innerWidth || document.documentElement.clientWidth;
            if (width < 1000) {
                var head = document.getElementsByTagName('head')[0] || document.head || document.documentElement;
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.charset = 'utf-8';
                script.id = 'changyan_mobile_js';
                script.src = 'https://cy-cdn.kuaizhan.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf;
                head.appendChild(script);
            } else {
                var loadJs = function(d, a) {
                    var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
                    var b = document.createElement("script");
                    b.setAttribute("type", "text/javascript");
                    b.setAttribute("charset", "UTF-8");
                    b.setAttribute("src", d);
                    if (typeof a === "function") {
                        if (window.attachEvent) {
                            b.onreadystatechange = function() {
                                var e = b.readyState;
                                if (e === "loaded" || e === "complete") {
                                    b.onreadystatechange = null;
                                    a()
                                }
                            }
                        } else {
                            b.onload = a
                        }
                    }
                    c.appendChild(b)
                };
                loadJs("https://cy-cdn.kuaizhan.com/upload/changyan.js",
                function() {
                    window.changyan.api.config({
                        appid: appid,
                        conf: conf
                    })
                });
            }
        }
    </script>
</body>
</html>
